USE [DB_AHSECO]
GO

CREATE OR ALTER PROCEDURE [dbo].[USP_SEL_DESPACHO] 
(
/*=======================================================================================================
	Nombre:				Fecha:			Descripcion:
	Jose Peralta		14.11.24		Realiza consulta de datos del despacho.
	EXEC [USP_SEL_DESPACHO]  20
=======================================================================================================*/
	@isIdSolicitud BIGINT
)
AS
BEGIN

	SELECT  ID,ID_SOLICITUD,STOCK,NUMORDEN,
	CONVERT(VARCHAR(8),FECHAORDEN,112) FECHAORDEN,
	CONVERT(VARCHAR(8),FECHAMAX,112) FECHAMAX,
	ISNULL(CONVERT(VARCHAR(8),FECHAENTREGA,112),'') FECHAENTREGA,
	ISNULL(NUMFACTURA,'') NUMFACTURA,
	ISNULL(NUMGUIAREM,'') NUMGUIAREM,
	ISNULL(NUMPEDIDO,'') NUMPEDIDO,
	ISNULL(CONVERT(VARCHAR(8),FECHAINGRESO,112),'') FECHAINGRESO,
	ISNULL(ESTAPROB,'') ESTAPROB,
	ISNULL(CONVERT(VARCHAR(8),FECAPROB,112),'') FECAPROB,
	ISNULL(OBSERVACION,'') OBSERVACION,
	USR_REG,
	FEC_REG,
	USR_MOD,
	FEC_MOD
	FROM TBM_DESPACHO A WITH(NOLOCK) WHERE ID_SOLICITUD= @isIdSolicitud AND STOCK='S'

	SELECT ROW_NUMBER() OVER (ORDER BY A.ID) AS ROWNUM,
	C.CODITEM CODEQUIPO,
	C.DESCRIPCION,
	E.TG_CDESCRI MARCA,
	ISNULL(A.NUMSERIE,'') NUMSERIE 
	FROM TBD_DESPACHO_DIST A WITH(NOLOCK) 
	INNER JOIN TBD_COTIZACIONCOSTOS B ON A.ID_COTCOSTOS=B.ID
	INNER JOIN TBD_COTIZACIONVENTA C ON B.ID_COTDETALLE=C.ID
	INNER JOIN [AH-SRV4].[RSFACCAR].[dbo].[AL0007ARTI] D WITH(NOLOCK) ON C.CODITEM=D.AR_CCODIGO
	LEFT JOIN  [AH-SRV4].[RSFACCAR].[dbo].[AL0007TABL] E WITH(NOLOCK) ON E.TG_CCOD='V7' AND D.AR_CMARCA=E.TG_CCLAVE 
	WHERE 
	A.ID_DESPACHO IN (SELECT ID FROM TBM_DESPACHO WHERE ID_SOLICITUD=@isIdSolicitud AND STOCK='S' )


	SELECT  ID,ID_SOLICITUD,STOCK,NUMORDEN,
	CONVERT(VARCHAR(8),FECHAORDEN,112) FECHAORDEN,
	CONVERT(VARCHAR(8),FECHAMAX,112) FECHAMAX,
	ISNULL(CONVERT(VARCHAR(8),FECHAENTREGA,112),'') FECHAENTREGA,
	ISNULL(NUMFACTURA,'') NUMFACTURA,
	ISNULL(NUMGUIAREM,'') NUMGUIAREM,
	ISNULL(NUMPEDIDO,'') NUMPEDIDO,
	ISNULL(CONVERT(VARCHAR(8),FECHAINGRESO,112),'') FECHAINGRESO,
	ISNULL(ESTAPROB,'') ESTAPROB,
	ISNULL(CONVERT(VARCHAR(8),FECAPROB,112),'') FECAPROB,
	ISNULL(OBSERVACION,'') OBSERVACION,
	USR_REG,
	FEC_REG,
	USR_MOD,
	FEC_MOD
	FROM TBM_DESPACHO A WITH(NOLOCK) WHERE ID_SOLICITUD= @isIdSolicitud AND STOCK='N'

	SELECT ROW_NUMBER() OVER (ORDER BY A.ID) AS ROWNUM,
	C.CODITEM CODEQUIPO,
	C.DESCRIPCION,
	E.TG_CDESCRI MARCA,
	ISNULL(A.NUMSERIE,'') NUMSERIE 
	FROM TBD_DESPACHO_DIST A WITH(NOLOCK) 
	INNER JOIN TBD_COTIZACIONCOSTOS B ON A.ID_COTCOSTOS=B.ID
	INNER JOIN TBD_COTIZACIONVENTA C ON B.ID_COTDETALLE=C.ID
	INNER JOIN [AH-SRV4].[RSFACCAR].[dbo].[AL0007ARTI] D WITH(NOLOCK) ON C.CODITEM=D.AR_CCODIGO
	LEFT JOIN  [AH-SRV4].[RSFACCAR].[dbo].[AL0007TABL] E WITH(NOLOCK) ON E.TG_CCOD='V7' AND D.AR_CMARCA=E.TG_CCLAVE 
	WHERE 
	A.ID_DESPACHO IN (SELECT ID FROM TBM_DESPACHO WHERE ID_SOLICITUD=@isIdSolicitud AND STOCK='N' )

END